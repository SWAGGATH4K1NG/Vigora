{
  "openapi": "3.0.3",
  "info": {
    "title": "PWA Personal Trainers API",
    "version": "1.0.0"
  },
  "servers": [{ "url": "http://localhost:3000" }],
  "paths": {
    "/api/auth/login": {
      "post": {
        "summary": "Login (email/username + password)",
        "tags": ["Auth"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/LoginRequest" }
            }
          }
        },
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/AuthResponse" } } } },
          "401": { "description": "Credenciais inválidas" }
        }
      }
    },
    "/api/auth/refresh": {
      "post": {
        "summary": "Refresh do access token com refresh token",
        "tags": ["Auth"],
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/RefreshRequest" } } }
        },
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/RefreshResponse" } } } },
          "401": { "description": "Refresh token inválido/expirado" }
        }
      }
    },

    "/api/plans/plans": {
      "get": {
        "summary": "Listar planos",
        "tags": ["Plans"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "query", "name": "clientId", "schema": { "type": "string" } },
          { "in": "query", "name": "trainerId", "schema": { "type": "string" } },
          { "in": "query", "name": "page", "schema": { "type": "integer", "default": 1 } },
          { "in": "query", "name": "limit", "schema": { "type": "integer", "default": 20 } }
        ],
        "responses": {
          "200": { "description": "OK" }
        }
      },
      "post": {
        "summary": "Criar plano",
        "tags": ["Plans"],
        "security": [{ "bearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": { "application/json": { "schema": { "$ref": "#/components/schemas/TrainingPlanInput" } } }
        },
        "responses": {
          "201": { "description": "Criado" },
          "403": { "description": "Trainer não validado" }
        }
      }
    },
    "/api/plans/plans/{id}": {
      "get": {
        "summary": "Obter plano por ID",
        "tags": ["Plans"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [{ "in": "path", "name": "id", "required": true, "schema": { "type": "string" } }],
        "responses": { "200": { "description": "OK" }, "404": { "description": "Não encontrado" } }
      },
      "patch": {
        "summary": "Atualizar plano",
        "tags": ["Plans"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [{ "in": "path", "name": "id", "required": true, "schema": { "type": "string" } }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/TrainingPlanPartial" } } } },
        "responses": { "200": { "description": "OK" }, "404": { "description": "Não encontrado" } }
      },
      "delete": {
        "summary": "Remover plano",
        "tags": ["Plans"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [{ "in": "path", "name": "id", "required": true, "schema": { "type": "string" } }],
        "responses": { "200": { "description": "Removido" }, "404": { "description": "Não encontrado" } }
      }
    },

    "/api/plans/plans/{planId}/sessions": {
      "get": {
        "summary": "Listar sessões de um plano",
        "tags": ["Sessions"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "path", "name": "planId", "required": true, "schema": { "type": "string" } },
          { "in": "query", "name": "dayOfWeek", "schema": { "type": "integer", "minimum": 0, "maximum": 6 } }
        ],
        "responses": { "200": { "description": "OK" } }
      },
      "post": {
        "summary": "Criar sessão (máx. 10 exercícios)",
        "tags": ["Sessions"],
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/TrainingSessionInput" } } } },
        "responses": { "201": { "description": "Criado" }, "400": { "description": "Mais de 10 exercícios" } }
      }
    },

    "/api/plans/sessions/{id}": {
      "get": {
        "summary": "Obter sessão por ID",
        "tags": ["Sessions"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [{ "in": "path", "name": "id", "required": true, "schema": { "type": "string" } }],
        "responses": { "200": { "description": "OK" }, "404": { "description": "Não encontrada" } }
      },
      "patch": {
        "summary": "Atualizar sessão (máx. 10 exercícios)",
        "tags": ["Sessions"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [{ "in": "path", "name": "id", "required": true, "schema": { "type": "string" } }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/TrainingSessionPartial" } } } },
        "responses": { "200": { "description": "OK" }, "400": { "description": "Mais de 10 exercícios" } }
      },
      "delete": {
        "summary": "Remover sessão",
        "tags": ["Sessions"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [{ "in": "path", "name": "id", "required": true, "schema": { "type": "string" } }],
        "responses": { "200": { "description": "Removida" }, "404": { "description": "Não encontrada" } }
      }
    },

    "/api/completion": {
      "get": {
        "summary": "Listar registos de cumprimento",
        "tags": ["Completion"],
        "security": [{ "bearerAuth": [] }],
        "parameters": [
          { "in": "query", "name": "clientId", "schema": { "type": "string" } },
          { "in": "query", "name": "trainerId", "schema": { "type": "string" } },
          { "in": "query", "name": "status", "schema": { "type": "string", "enum": ["DONE","MISSED"] } },
          { "in": "query", "name": "from", "schema": { "type": "string", "format": "date" } },
          { "in": "query", "name": "to", "schema": { "type": "string", "format": "date" } }
        ],
        "responses": { "200": { "description": "OK" } }
      },
      "post": {
        "summary": "Marcar sessão DONE/MISSED (idempotente por dia)",
        "tags": ["Completion"],
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": true, "content": { "application/json": { "schema": { "$ref": "#/components/schemas/CompletionInput" } } } },
        "responses": { "201": { "description": "Criado/Atualizado" } }
      }
    },

    "/api/uploads": {
      "post": {
        "summary": "Fazer upload de um ficheiro",
        "tags": ["Uploads"],
        "security": [{ "bearerAuth": [] }],
        "requestBody": { "required": true, "content": { "multipart/form-data": { "schema": { "type": "object", "properties": { "file": { "type": "string", "format": "binary" }, "purpose": { "type": "string" }, "metadata": { "type": "string" } }, "required": ["file"] } } } },
        "responses": { "201": { "description": "Criado" } }
      },
      "get": {
        "summary": "Listar ficheiros do utilizador",
        "tags": ["Uploads"],
        "security": [{ "bearerAuth": [] }],
        "responses": { "200": { "description": "OK" } }
      }
    }
  },

  "components": {
    "securitySchemes": {
      "bearerAuth": { "type": "http", "scheme": "bearer", "bearerFormat": "JWT" }
    },
    "schemas": {
      "LoginRequest": {
        "type": "object",
        "required": ["emailOrUsername","password"],
        "properties": {
          "emailOrUsername": { "type": "string" },
          "password": { "type": "string", "format": "password" }
        }
      },
      "AuthResponse": {
        "type": "object",
        "properties": {
          "user": { "type": "object" },
          "accessToken": { "type": "string" },
          "refreshToken": { "type": "string" }
        }
      },
      "RefreshRequest": {
        "type": "object",
        "required": ["refreshToken"],
        "properties": { "refreshToken": { "type": "string" } }
      },
      "RefreshResponse": {
        "type": "object",
        "properties": {
          "accessToken": { "type": "string" },
          "refreshToken": { "type": "string" }
        }
      },
      "TrainingPlanInput": {
        "type": "object",
        "required": ["clientId","trainerId","title","frequencyPerWeek","startDate"],
        "properties": {
          "clientId": { "type": "string" },
          "trainerId": { "type": "string" },
          "title": { "type": "string" },
          "description": { "type": "string" },
          "frequencyPerWeek": { "type": "integer", "enum": [3,4,5] },
          "startDate": { "type": "string", "format": "date" },
          "endDate": { "type": "string", "format": "date" }
        }
      },
      "TrainingPlanPartial": { "type": "object", "properties": { "$ref": "#/components/schemas/TrainingPlanInput/properties" } },
      "TrainingSessionInput": {
        "type": "object",
        "required": ["dayOfWeek"],
        "properties": {
          "dayOfWeek": { "type": "integer", "minimum": 0, "maximum": 6 },
          "order": { "type": "integer" },
          "notes": { "type": "string" },
          "exercises": {
            "type": "array",
            "maxItems": 10,
            "items": { "$ref": "#/components/schemas/Exercise" }
          }
        }
      },
      "TrainingSessionPartial": { "type": "object", "properties": { "$ref": "#/components/schemas/TrainingSessionInput/properties" } },
      "Exercise": {
        "type": "object",
        "required": ["name","sets","reps"],
        "properties": {
          "name": { "type": "string" },
          "sets": { "type": "integer", "minimum": 1 },
          "reps": { "type": "integer", "minimum": 1 },
          "notes": { "type": "string" },
          "mediaUrl": { "type": "string" }
        }
      },
      "CompletionInput": {
        "type": "object",
        "required": ["clientId","trainerId","planId","sessionId","date","status"],
        "properties": {
          "clientId": { "type": "string" },
          "trainerId": { "type": "string" },
          "planId": { "type": "string" },
          "sessionId": { "type": "string" },
          "date": { "type": "string", "format": "date" },
          "status": { "type": "string", "enum": ["DONE","MISSED"] },
          "reason": { "type": "string" },
          "proofImage": { "type": "string" }
        }
      }
    }
  }
}
